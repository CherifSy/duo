#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander');
var join = require('path').join;
var assert = require('assert');
var duo = require('..');
var fs = require('fs');
var co = require('co');

/**
 * Options
 */

program
  .usage('duo build')
  .option('-e, --entry <file>', 'specify entry point')
  .option('-d, --dev', 'build development dependencies too.', false)
  .option('-t, --to <file>', 'build to the given `path`', 'build/build.js')
  .option('-c, --concurrency <n>', 'set cuncurrency', 10)
  .parse(process.argv);

/**
 * Examples
 */

program.on('--help', function(){
  console.log('  Examples:');
  console.log();
  console.log('  # build')
  console.log('  $ duo build');
  console.log();
  process.exit(0);
});

/**
 * Build
 */

co(function*(){
  try {
    yield build;
  } catch (e) {
    console.error();
    console.error('  %s', e.stack);
    console.error();
    process.exit(1);
  }
})();

/**
 * Build
 */

function *build(){
  var root = process.cwd();
  var meta = yield json(join(root, 'component.json'));
  var start = new Date;

  // entry
  var entry = program.entry
    ? join(process.cwd(), program.entry)
    : join(root, getEntry(meta));

  // concurrency
  var concurrency = /^infinity$/i.test(program.concurrency)
    ? Infinity
    : program.concurrency;

  assert(entry, 'didn\'t find entry point for "' + meta.name + '"');

  yield duo.build(entry)
    .development(program.dev || false)
    .directory(process.cwd())
    .concurrency(concurrency)
    .to(program.to)
    .build();

  console.log();
  console.log('  \033[36mbuilt\033[m : \033[90m%s\033[m', program.to);
  console.log('  \033[36mtook\033[m  : \033[90m%sms\033[m', new Date - start);
  console.log();
}

/**
 * Read json thunk
 */

function json(path){
  return function(done){
    fs.readFile(path, 'utf8', function(err, buf){
      if (err) return done(err);

      try {
        done(null, JSON.parse(buf));
      } catch (e) {
        done(e);
      }
    });
  };
}

/**
 * Get entry point.
 * 
 * TODO: move to utils and search locals etc.. ?
 */

function getEntry(meta){
  return meta.main || meta.scripts[0];
}
